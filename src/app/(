'use client';

import { useState, lazy, Suspense, useMemo, useCallback } from 'react';
import { useRouter, usePathname } from 'next/navigation';
import { Button } from '@/components/ui/button';
import { VirtualizedDataTable } from '@/components/ui/virtualized-data-table';
import { PageLayout } from '@/components/layouts/PageLayout';
import { Badge } from '@/components/ui/badge';
import Link from 'next/link';
import { toast } from 'sonner';
import { ArrowUpRight, Download, Plus, Loader2 } from 'lucide-react';

// Performance monitoring imports
import { usePerformanceMonitor, useFPSMonitor } from '@/lib/performance-monitor';
import { useCachedQuery, usePrefetchWithCache } from '@/lib/api-cache';
import { SmartRouteWrapper } from '@/lib/route-splitting';

// Optimized skeleton
import { TableSkeleton } from '@/components/ui/skeleton-optimized';
import type { BeneficiaryDocument } from '@/types/database';

// Mock API for demo
const mockApi = {
  beneficiaries: {
    getBeneficiaries: async ({ page, limit, search }: any) => {
      await new Promise(resolve => setTimeout(resolve, 500));
      
      const data = Array.from({ length: limit }, (_, i) => ({
        _id: `${page}-${i}`,
        name: `İhtiyaç Sahibi ${page}-${i}`,
        nationality: 'Türk',
        tc_no: `1234567890${i}`,
        phone: `+90 555 ${String(i).padStart(3, '0')} ${String(i + 1).padStart(3, '0')} ${String(i + 2).padStart(3, '0')}`,
        city: 'İstanbul',
        district: 'Kadıköy',
        address: `${i} Test Mahallesi Test Sokak No:${i}`,
        family_size: Math.floor(Math.random() * 8) + 1,
      }));
      
      return { data, total: 500, page, limit };
    }
  }
};

// Stub export function
const exportBeneficiaries = async (params: any) => {
  toast.info('Dışa aktarma özelliği yakında eklenecek');
  return Promise.resolve({ success: true, data: null, error: null });
};

// Lazy load modal
const BeneficiaryQuickAddModal = lazy(() =>
  import('@/components/forms/BeneficiaryQuickAddModal').then((mod) => ({
    default: mod.BeneficiaryQuickAddModal,
  }))
);

export default function BeneficiariesPage() {
  const router = useRouter();
  const pathname = usePathname();
  
  // Performance monitoring
  const { trackRouteTransition, trackModalPerformance, getMetrics } = usePerformanceMonitor('beneficiaries');
  const { getFPS, isGoodPerformance } = useFPSMonitor();
  
  // Smart caching
  const { prefetch } = usePrefetchWithCache();
  
  const [search, setSearch] = useState('');
  const [page, setPage] = useState(1);
  const [showQuickAddModal, setShowQuickAddModal] = useState(false);
  const limit = 20;

  // Use cached query
  const { data, isLoading, error, refetch } = useCachedQuery({
    endpoint: '/api/beneficiaries',
    params: { page, limit, search },
    dataType: 'beneficiaries',
    staleTime: 5 * 60 * 1000,
    enabled: true,
  });

  const beneficiaries = data?.data || [];
  const total = data?.total || 0;
  const totalPages = Math.max(1, Math.ceil(total / limit));

  // Memoized columns
  const columns = useMemo(() => [
    {
      key: 'actions',
      label: '',
      render: (item: BeneficiaryDocument) => (
        <Link href={`/yardim/ihtiyac-sahipleri/${item._id}`}>
          <Button variant="ghost" size="icon-sm" className="h-8 w-8">
            <ArrowUpRight className="h-4 w-4" />
          </Button>
        </Link>
      ),
      className: 'w-12',
    },
    {
      key: 'type',
      label: 'Tür',
      render: () => (
        <Badge variant="secondary" className="font-medium">
          İhtiyaç Sahibi
        </Badge>
      ),
    },
    {
      key: 'name',
      label: 'İsim',
      render: (item: BeneficiaryDocument) => <span className="font-medium">{item.name || '-'}</span>,
    },
    {
      key: 'nationality',
      label: 'Uyruk',
      render: (item: BeneficiaryDocument) => item.nationality || '-',
    },
    {
      key: 'tc_no',
      label: 'Kimlik No',
      render: (item: BeneficiaryDocument) => item.tc_no || '-',
    },
    {
      key: 'phone',
      label: 'Telefon',
      render: (item: BeneficiaryDocument) => item.phone || '-',
    },
    {
      key: 'city',
      label: 'Şehir',
      render: (item: BeneficiaryDocument) => item.city || '-',
    },
    {
      key: 'district',
      label: 'İlçe',
      render: (item: BeneficiaryDocument) => item.district || '-',
    },
    {
      key: 'address',
      label: 'Adres',
      render: (item: BeneficiaryDocument) => (
        <span className="max-w-xs truncate" title={item.address || '-'}>
          {item.address || '-'}
        </span>
      ),
    },
    {
      key: 'family_size',
      label: 'Aile Büyüklüğü',
      render: (item: BeneficiaryDocument) => <Badge variant="outline">{item.family_size ?? '-'}</Badge>,
    },
  ], []);

  // Memoized handlers
  const handleModalClose = useCallback(() => {
    setShowQuickAddModal(false);
    refetch();
  }, [refetch]);

  const handleExport = useCallback(async () => {
    const result = await exportBeneficiaries({ search });
    if (result.success) {
      toast.success('Veri başarıyla dışa aktarıldı');
    }
  }, [search]);

  const handleShowModal = useCallback(() => {
    setShowQuickAddModal(true);
  }, []);

  // Performance monitoring
  React.useEffect(() => {
    if (!isGoodPerformance()) {
      console.warn('Performance degraded:', { fps: getFPS() });
    }
  }, [getFPS, isGoodPerformance]);

  // Prefetch on mount
  React.useEffect(() => {
    prefetch({
      endpoint: '/api/aid-applications',
      dataType: 'applications',
      priority: 'normal',
    });
  }, [prefetch]);

  return (
    <SmartRouteWrapper chunkName="beneficiaries" priority="high" loadingType="table">
      <PageLayout
        title="İhtiyaç Sahipleri"
        description="Kayıtlı ihtiyaç sahiplerini görüntüleyin ve yönetin"
        actions={
          <>
            <Button variant="outline" onClick={handleExport} className="gap-2">
              <Download className="h-4 w-4" />
              Dışa Aktar
            </Button>
            <Button onClick={handleShowModal} className="gap-2">
              <Plus className="h-4 w-4" />
              Yeni Ekle
            </Button>
          </>
        }
      >
        {showQuickAddModal && (
          <Suspense fallback={
            <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50">
              <div className="bg-background rounded-lg shadow-lg border p-6 max-w-md w-full mx-4">
                <TableSkeleton rows={4} />
              </div>
            </div>
          }>
            <BeneficiaryQuickAddModal open={showQuickAddModal} onOpenChange={handleModalClose} />
          </Suspense>
        )}

        <VirtualizedDataTable<BeneficiaryDocument>
          data={beneficiaries}
          columns={columns}
          isLoading={isLoading}
          error={error as Error}
          emptyMessage="İhtiyaç sahibi bulunamadı"
          emptyDescription="Henüz kayıt eklenmemiş"
          searchable={true}
          searchValue={search}
          onSearchChange={(value) => {
            setSearch(value);
            setPage(1);
          }}
          searchPlaceholder="İsim, TC No veya telefon ile ara..."
          pagination={{
            page,
            totalPages,
            total,
            onPageChange: setPage,
          }}
          onRowClick={(item) => router.push(`/yardim/ihtiyac-sahipleri/${item._id}`)}
          refetch={refetch}
          rowHeight={60}
          containerHeight={600}
        />
      </PageLayout>
    </SmartRouteWrapper>
  );
}
